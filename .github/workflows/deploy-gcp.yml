name: Deploy Frontend to Google Cloud Storage

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCS_BUCKET: mothership-frontend-assets

jobs:
  setup-build-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build application
      run: npm run build

    - name: Deploy to GCS
      run: |-
        gsutil -m rsync -d -r ./dist gs://${{ env.GCS_BUCKET }}
        gsutil -h "Cache-Control:no-cache, no-store, must-revalidate" \
          cp ./dist/index.html gs://${{ env.GCS_BUCKET }}/index.html

    - name: Invalidate CDN Cache
      run: |-
        gcloud compute url-maps invalidate-cdn-cache mothership-frontend-url-map --path "/*" --project="${{ env.PROJECT_ID }}"
